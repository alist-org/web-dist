import{b as O,b9 as h,bq as g,B as b,x as e,dk as J,ai as E,bW as x,Q as w,br as k,n as $,S as f,av as y,ah as _,bX as Q,dl as Y,cH as se,aZ as ae,R as ie,M as oe,I as le,bu as ue,J as ce,K as de,bR as M,bE as I,L as D,T as ge,O as he,V as v,am as z,d as me,ay as a,dm as L,r as pe,ax as C,an as R,dn as we,dp as fe,dq as _e,dr as $e,ds as X,N as V,ap as ye,W as j,aW as be,cI as ke,cx as Se}from"./index-bcc8ecfe.js";import{b as xe}from"./useTitle-3c2cdb8f.js";import{L as ve}from"./index-25ad48d0.js";import{s as G,c as Ce,b as Me}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Ie=t=>{const n=O(),[u,c]=h(()=>g.post("/authn/delete_authn",{id:t.id})),[m,l]=b(!1);return e(f,{get when(){return!m()},get children(){return e(J,{w:"$full",overflowX:"auto",shadow:"$md",rounded:"$lg",p:"$2",direction:{"@initial":"column","@xl":"row"},spacing:"$2",get children(){return[e(E,{w:"$full",alignItems:"start",spacing:"$1",get children(){return e(x,{color:"$info9",css:{wordBreak:"break-all"},get children(){return"Fingerprint: "+t.fingerprint+"	ID: "+t.id}})}}),e(J,{direction:{"@initial":"row","@xl":"column"},justifyContent:{"@xl":"center"},spacing:"$1",get children(){return e(w,{colorScheme:"danger",get loading(){return u()},onClick:async()=>{const i=await c();k(i,()=>{$.success(n("global.delete_success")),l(!0)})},get children(){return n("global.delete")}})}})]}})}})},Ae=t=>{const n=t.getFullYear().toString(),u=(t.getMonth()+1).toString().padStart(2,"0"),c=t.getDate().toString().padStart(2,"0"),m=t.getHours().toString().padStart(2,"0"),l=t.getMinutes().toString().padStart(2,"0"),i=t.getSeconds().toString().padStart(2,"0");return`${n}/${u}/${c} ${m}:${l}:${i}`},s=[{name:"title",textAlign:"left",w:"calc(35% - 110px)"},{name:"fingerprint",textAlign:"left",w:"calc(65% - 110px)"},{name:"last_used",textAlign:"right",w:"140px"},{name:"operation",textAlign:"right",w:"80px"}],Pe=t=>{const n=O(),[u,c]=b(!1),[m,l]=t.isMine?h(()=>g.post(`/me/sshkey/delete?id=${t.id}`)):h(()=>g.post(`/admin/user/sshkey/delete?uid=${t.userId}&id=${t.id}`)),i={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"};return e(f,{get when(){return!u()},get children(){return e(y,{w:"$full",p:"$2",get children(){return[e(x,{get w(){return s[0].w},size:"sm",get textAlign(){return s[0].textAlign},css:i,get children(){return t.title}}),e(_,{get w(){return s[1].w},size:"sm",get textAlign(){return s[1].textAlign},css:i,get children(){return t.fingerprint}}),e(_,{get w(){return s[2].w},size:"sm",get textAlign(){return s[2].textAlign},css:i,get children(){return Ae(new Date(t.last_used_time))}}),e(Q,{get w(){return s[3].w},gap:"$1",get children(){return[e(Y,{}),e(w,{size:"sm",colorScheme:"danger",get loading(){return m()},onClick:async()=>{const p=await l();k(p,()=>{$.success(n("global.delete_success")),c(!0)})},get children(){return n("global.delete")}})]}})]}})}})},Te=t=>{const n=O(),[u,c]=b([]),[m,l]=t.isMine?h(()=>g.get("/me/sshkey/list")):h(()=>g.get(`/admin/user/sshkey/list?uid=${t.userId}`)),[i,p]=se({title:"",key:""}),[W,H]=h(()=>g.post("/me/sshkey/add",i)),{isOpen:A,onOpen:U,onClose:P}=ae(),T=async()=>{const o=await l();k(o,q=>{c(q.content)})};T();const S=o=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:o.textAlign});return e(E,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[e(Q,{w:"$full",get children(){return[e(x,{get children(){return n("users.ssh_keys.heading")}}),e(f,{get when(){return t.isMine},get children(){return[e(Y,{}),e(w,{get loading(){return m()},onClick:U,get children(){return n("global.add")}}),e(ie,{get opened(){return A()},onClose:P,scrollBehavior:"inside",get children(){return[e(oe,{}),e(le,{get children(){return[e(ue,{}),e(ce,{get children(){return n("users.ssh_keys.add_heading")}}),e(de,{get children(){return[e(M,{mb:"$4",get children(){return[e(I,{for:"add_title",get children(){return n("users.ssh_keys.title")}}),e(D,{id:"add_title",get value(){return i.title},onInput:o=>p("title",o.currentTarget.value)})]}}),e(M,{get children(){return[e(I,{for:"add_key",get children(){return n("users.ssh_keys.key")}}),e(ge,{id:"add_key",get value(){return i.key},onInput:o=>p("key",o.currentTarget.value)})]}})]}}),e(he,{get children(){return e(w,{get loading(){return W()},onClick:async()=>{const o=await H();k(o,()=>{p("title",""),p("key",""),T(),P()})},get children(){return n("global.add")}})}})]}})]}})]}})]}}),e(E,{w:"$full",overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[e(y,{class:"title",w:"$full",p:"$2",get children(){return[e(_,v({get w(){return s[0].w}},()=>S(s[0]),{get children(){return n(`users.ssh_keys.${s[0].name}`)}})),e(_,v({get w(){return s[1].w}},()=>S(s[1]),{get children(){return n(`users.ssh_keys.${s[1].name}`)}})),e(_,v({get w(){return s[2].w}},()=>S(s[2]),{get children(){return n(`users.ssh_keys.${s[2].name}`)}})),e(_,v({get w(){return s[3].w}},()=>S(s[3]),{get children(){return n(`users.ssh_keys.${s[3].name}`)}}))]}}),z(()=>u().map(o=>e(Pe,v(t,o))))]}})]}})},Be=t=>e(ke,{get colorScheme(){return t.can?"success":"danger"},get children(){return t.children}}),Ee=()=>{const t=O();xe("manage.sidemenu.profile");const{searchParams:n,to:u}=me(),[c,m]=b(a().username),[l,i]=b(""),[p,W]=b(""),H=R("sso_compatibility_mode"),[A,U]=h(r=>g.post("/me/update",{username:r?a().username:c(),password:r?"":l(),sso_id:a().sso_id})),[P,T]=h(()=>g.get("/authn/getcredentials")),[,S]=h(()=>g.get("/authn/webauthn_begin_registration")),[o,q]=h((r,d)=>g.post("/authn/webauthn_finish_registration",JSON.stringify(d),{headers:{session:r}})),B=async r=>{if(l()&&l()!==p()){$.warning(t("users.confirm_password_not_same"));return}const d=await U(r);k(d,()=>{L({...a(),username:c()}),r?u(""):($.success(t("users.update_profile_success")),u(`/@login?redirect=${encodeURIComponent(location.pathname)}`))})},K=n.sso_id;K&&(L({...a(),sso_id:K}),B(!0));function N(r){const d=r.data;d.sso_id&&(L({...a(),sso_id:d.sso_id}),B(!0))}window.addEventListener("message",N),pe(()=>{window.removeEventListener("message",N)});const[Z,ee]=b([]),te=async()=>{const r=await T();Se(r,ee)};return G()&&!C.is_guest(a())&&R("webauthn_login_enabled")&&te(),e(E,{w:"$full",spacing:"$4",alignItems:"start",get children(){return[e(f,{get when(){return!C.is_guest(a())},get fallback(){return[e(we,{status:"warning",flexDirection:{"@initial":"column","@lg":"row"},get children(){return[e(fe,{mr:"$2_5"}),e(_e,{mr:"$2_5",get children(){return t("users.guest-tips")}}),e($e,{get children(){return t("users.modify_nothing")}})]}}),e(y,{spacing:"$2",get children(){return[e(_,{get children(){return t("global.have_account")}}),e(_,{color:"$info9",as:ve,get href(){return`/@login?redirect=${encodeURIComponent(location.pathname)}`},get children(){return t("global.go_login")}})]}})]},get children(){return[e(x,{get children(){return t("users.update_profile")}}),e(X,{gap:"$2",columns:{"@initial":1,"@md":2},get children(){return e(M,{get children(){return[e(I,{for:"username",get children(){return t("users.change_username")}}),e(D,{id:"username",get value(){return c()},onInput:r=>{m(r.currentTarget.value)}})]}})}}),e(X,{gap:"$2",columns:{"@initial":1,"@md":2},get children(){return[e(M,{get children(){return[e(I,{for:"password",get children(){return t("users.change_password")}}),e(D,{id:"password",type:"password",placeholder:"********",get value(){return l()},onInput:r=>{i(r.currentTarget.value)}}),e(V,{get children(){return t("users.change_password-tips")}})]}}),e(M,{get children(){return[e(I,{for:"confirm-password",get children(){return t("users.confirm_password")}}),e(D,{id:"confirm-password",type:"password",placeholder:"********",get value(){return p()},onInput:r=>{W(r.currentTarget.value)}}),e(V,{get children(){return t("users.confirm_password-tips")}})]}})]}}),e(y,{spacing:"$2",get children(){return[e(w,{get loading(){return A()},onClick:[B,!1],get children(){return t("global.save")}}),e(f,{get when(){return!a().otp},get children(){return e(w,{colorScheme:"accent",onClick:()=>{u("/@manage/2fa")},get children(){return t("users.enable_2fa")}})}})]}})]}}),e(f,{get when(){return z(()=>!!R("sso_login_enabled"),!0)()&&!C.is_guest(a())},get children(){return[e(x,{get children(){return t("users.sso_login")}}),e(y,{spacing:"$2",get children(){return e(f,{get when(){return a().sso_id},get fallback(){return e(w,{onClick:()=>{const r=g.getUri()+"/auth/sso?method=get_sso_id";if(H){window.location.href=r;return}window.open(r,"authPopup","width=500,height=600")},get children(){return t("users.connect_sso")}})},get children(){return e(w,{colorScheme:"danger",get loading(){return A()},onClick:()=>{L({...a(),sso_id:""}),B(!0)},get children(){return t("users.disconnect_sso")}})}})}})]}}),e(f,{get when(){return z(()=>!C.is_guest(a()),!0)()&&R("webauthn_login_enabled")},get children(){return[e(x,{get children(){return t("users.webauthn")}}),e(y,{wrap:"wrap",gap:"$2",mt:"$2",get children(){return e(ye,{get loading(){return P()},get children(){return e(j,{get each(){return Z()},children:r=>e(Ie,{get id(){return r.id},get fingerprint(){return r.fingerprint}})})}})}}),e(w,{get loading(){return o()},onClick:async()=>{if(!G()){$.error(t("users.webauthn_not_supported"));return}const r=await S();k(r,async d=>{const re=Ce(d.options),ne=d.session;try{const F=await Me(re);k(await q(ne,F),()=>{$.success(t("users.add_webauthn_success"))})}catch(F){F instanceof Error&&$.error(F.message)}})},get children(){return t("users.add_webauthn")}})]}}),e(y,{wrap:"wrap",gap:"$2",mt:"$2",get children(){return e(j,{each:be,children:(r,d)=>e(Be,{get can(){return C.can(a(),d())},get children(){return t(`users.permissions.${r}`)}})})}}),e(Te,{isMine:!0,get userId(){return a().id}})]}})};export{Ee as default};
