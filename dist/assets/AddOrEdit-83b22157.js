import{aZ as se,b as oe,B as x,H as U,x as e,L as V,ao as F,S as _,ah as D,W as M,d$ as E,e0 as H,aX as ue,ai as L,am as A,M as de,I as ge,bu as he,J as fe,av as q,K as me,O as pe,Q as J,R as be,dM as Se,dD as we,dJ as $e,A as te,b9 as X,e2 as G,_ as Q,dK as Ce,D as Pe,bb as le,dL as ke,aC as K,aO as ne,$ as ye,i as _e,br as Z,d as ve,cH as xe,e3 as je,q as Oe,aW as W,e4 as Ie,e5 as Fe,bW as Re,ap as De,bR as z,bE as B,bG as Me,bH as Te,bI as We,e1 as ze,bL as Be,bM as Ee,bN as He,bO as Le,n as re,j as Ae}from"./index-bbb652ad.js";import{v as qe,j as Je}from"./index-f8caf5d1.js";const Ke=(t,p,a)=>{const u=t.join("/");if(console.log("计算节点状态:",{当前路径:u,选中路径:p,子节点:a}),p.some(i=>{const w=i.join("/")===u;return w&&console.log("节点直接选中:",u),w}))return{checked:!0,indeterminate:!1};if(!(a!=null&&a.length))return p.some(C=>C.join("/").startsWith(u+"/"))?(console.log("是选中路径的父节点:",u),{checked:!1,indeterminate:!0}):{checked:!1,indeterminate:!1};let h=0,m=!1;return a.forEach(i=>{const w=[...t,i.name].join("/"),c=p.some(n=>n.join("/")===w),r=p.some(n=>n.join("/").startsWith(w+"/"));c?h++:r&&(m=!0)}),console.log("子节点状态:",{路径:u,选中数:h,总数:a.length,有半选:m}),h===a.length?{checked:!0,indeterminate:!1}:h>0||m?{checked:!1,indeterminate:!0}:{checked:!1,indeterminate:!1}},ae=t=>{const{isHidePath:p}=we(),[a,u]=x(),[s,h]=x(!1),{value:m,onChange:i,forceRoot:C,autoOpen:w,showEmptyIcon:c,showHiddenFolder:r,selectedPaths:n,onSelect:d,multiSelect:b}=$e(Y),S=te(()=>{if(!n||!n())return{checked:!1,indeterminate:!1};const l=Ke(t.segments,n(),a());return console.log("节点状态计算:",{path:t.segments.join("/"),state:l,selectedPaths:n(),children:a()}),l});te(()=>{if(!n||!n())return!1;const l=n(),g=t.segments.join("/"),y=l.some($=>{const I=$.join("/");return g===""?$.length===1:I.startsWith(g+"/")&&I.split("/").length===g.split("/").length+1}),v=l.some($=>$.join("/").startsWith(g+"/"));return console.log("检查选中子节点:",{当前路径:g,有直接子节点:y,有深层子节点:v,选中路径:l}),y||v});const o=async(l,g)=>{if(l.stopPropagation(),console.log(`
========== 节点点击开始 ==========`),console.log("事件类型:",l.type),console.log("事件目标:",l.target),console.log("点击的路径段:",g),console.log("当前节点状态:",S()),console.log("当前选中路径:",n==null?void 0:n()),b&&d){const y=!S().checked;let v=[];if(a())v=a().map($=>[...g,$.name]);else try{const $=await G("/"+g.join("/"),Q(),!0);$.code===200&&(v=$.data.map(I=>[...g,I.name]))}catch($){console.error("获取子节点失败:",$)}d(g,y,v)}else i("/"+g.join("/"));console.log(`========== 节点点击结束 ==========
`)},f=()=>{var l;return!!(c&&a()!==void 0&&!((l=a())!=null&&l.length))},[P,k]=X(()=>G(t.segments.join("/"),Q(),C));let R=!1;const j=async()=>{var g;if((g=a())!=null&&g.length)return;const l=await k();Z(l,y=>{R=!0,u(y)},()=>{O()&&T()})},{isOpen:O,onToggle:T}=se(),N=()=>m()===t.segments.join("/"),ee=Ce(t.segments.join("/")),ie=l=>{l.stopPropagation(),O()?h(!0):(h(!1),j()),T()};U(()=>{const l=t.segments.length,g=n==null?void 0:n(),y=t.segments.join("/");(()=>s()?!1:!!(l===0&&(g!=null&&g.length)||l<3&&(g!=null&&g.some($=>$.join("/").startsWith(y+"/")))))()&&!O()&&(console.log("展开节点:",y),T(),j())}),U(Pe(m,async l=>{t.segments.length>=3||w&&ee(l)&&(O()||T(),R||j())}));const ce=()=>p(t.segments.join("/"))&&!ee(m());return e(_,{get when(){return r||!ce()},get children(){return e(F,{get children(){return[e(q,{spacing:"$2",alignItems:"center",get children(){return[e(_,{when:b,get children(){return e(F,{get children(){return e(le,{get checked(){return S().checked},get indeterminate(){return S().indeterminate}})}})}}),e(_,{get when(){return!P()},get fallback(){return e(ke,{size:"sm",get color(){return K()}})},get children(){return e(_,{get when(){return!f()},get fallback(){return e(ne,{get color(){return K()},as:qe})},get children(){return e(ne,{get color(){return K()},as:Je,get transform(){return O()?"rotate(90deg)":"none"},transition:"transform 0.2s",cursor:"pointer",onClick:ie})}})}}),e(D,{css:{whiteSpace:"nowrap"},fontSize:"$md",cursor:"pointer",px:"$1",rounded:"$md",get bgColor(){return N()?"$info8":"transparent"},get _hover(){return{backgroundColor:N()?"$info8":ye()}},onClick:l=>{l.stopPropagation(),o(l,t.segments)},get children(){return A(()=>t.segments.join("/")==="",!0)()?"root":_e(t.segments.join("/"))}})]}}),e(_,{get when(){return O()},get children(){return e(L,{mt:"$1",pl:"$4",alignItems:"start",spacing:"$1",get children(){return e(M,{get each(){return a()},children:l=>e(ae,{get segments(){return[...t.segments,l.name]}})})}})}})]}})}})},Y=Se(),Ue=t=>{var s;const[p,a]=x("/");(s=t.handle)==null||s.call(t,{setPath:a});const u=t.selectedPaths;return e(F,{class:"folder-tree-box",w:"$full",overflowX:"auto",get children(){return e(Y.Provider,{get value(){return{value:p,onChange:h=>{a(h),t.onChange(h)},autoOpen:t.autoOpen??!1,forceRoot:t.forceRoot??!1,showEmptyIcon:t.showEmptyIcon??!1,showHiddenFolder:t.showHiddenFolder??!0,multiSelect:t.multiSelect,selectedPaths:u,onSelect:t.onSelect}},get children(){return e(ae,{segments:[]})}})}})},Ve=t=>{const{isOpen:p,onOpen:a,onClose:u}=se(),s=oe(),[h,m]=x(t.value.map(c=>c.split("/").filter(Boolean))),[i,C]=x(t.value.map(c=>c.split("/").filter(Boolean)));U(()=>{if(t.value){const c=t.value.map(r=>r.split("/").filter(Boolean));m(c),C(c)}});const w=async(c,r,n)=>{console.log("选择处理开始:",{segments:c,checked:r,childPaths:n,当前选中:h(),当前显示:i()});let d=[...h()];const b=c.join("/");r?(c.length>0&&!d.some(S=>S.join("/")===b)&&d.push(c),n&&n.forEach(S=>{d.some(o=>o.join("/")===S.join("/"))||d.push(S)})):c.length===0?d=[]:d=d.filter(S=>{const o=S.join("/");return o!==b&&!o.startsWith(b+"/")}),m(d),C(d),t.onChange(d.map(S=>S.length===0?"/":"/"+S.join("/")))};return[e(F,{w:"$full",position:"relative",get children(){return[e(V,{get id(){return t.id},readOnly:!0,h:"44px",pl:"$4",pointerEvents:"none",_focus:{border:"none",boxShadow:"none"}}),e(F,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",display:"flex",alignItems:"center",flexWrap:"wrap",gap:"$2",maxW:"90%",pl:"$4",cursor:"pointer",onClick:a,zIndex:1,get children(){return e(_,{get when(){return i().length>0},get fallback(){return e(D,{color:"$neutral10",get children(){return s("global.choose_folder")}})},get children(){return[e(M,{get each(){return i().slice(0,3)},children:c=>{const r="/"+c.join("/");return e(E,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",maxW:"300px",title:r,get children(){return e(H,{css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:r})}})}}),e(_,{get when(){return i().length>3},get children(){return e(ue,{placement:"bottom",withArrow:!0,closeDelay:0,get label(){return e(L,{alignItems:"flex-start",spacing:"$1",get children(){return e(M,{get each(){return i().slice(3)},children:c=>e(D,{fontSize:"$sm",color:"$neutral8",css:{wordBreak:"break-all"},get children(){return"/"+c.join("/")}})})}})},get children(){return e(E,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(H,{get children(){return["+",A(()=>i().length-3)]}})}})}})}})]}})}})]}}),e(be,{size:"xl",get opened(){return p()},onClose:u,get children(){return[e(de,{}),e(ge,{get children(){return[e(he,{}),e(fe,{get children(){return e(q,{spacing:"$2",alignItems:"center",get children(){return[e(D,{fontWeight:"bold",get children(){return s("global.choose_folder")}}),e(D,{fontSize:"$sm",get children(){return["（",A(()=>s("global.please_click_to_select")),"）"]}})]}})}}),e(me,{get children(){return e(Y.Provider,{get value(){return{value:()=>"/",onChange:c=>{},forceRoot:!0,autoOpen:t.autoOpen??!1,showEmptyIcon:!1,showHiddenFolder:!0,selectedPaths:i,onSelect:w,multiSelect:t.multiSelect}},get children(){return e(Ue,{forceRoot:!0,onChange:c=>{},get multiSelect(){return t.multiSelect},selectedPaths:i,onSelect:w,get autoOpen(){return t.autoOpen}})}})}}),e(pe,{get children(){return[e(J,{colorScheme:"neutral",onClick:u,mr:"$2",get children(){return s("global.cancel")}}),e(J,{onClick:u,get children(){return s("global.confirm")}})]}})]}})]}})]},Xe=async t=>{const p=new Map,a=async r=>{try{const n=await G(r,Q(),!0);if(n.code===200)return n.data.map(b=>Ae(r,b.name))}catch(n){console.error(`获取目录 [${r}] 内容失败:`,n)}return[]},u=r=>r==="/"||!r.includes("/")?"/":r.substring(0,r.lastIndexOf("/")),s=new Set;t.forEach(r=>s.add(r)),t.forEach(r=>{let n=u(r);for(;n!=="";)s.add(n),n=u(n)});for(const r of s)if(!p.has(r)){const n=await a(r);p.set(r,n)}const h=(r,n)=>n==="/"?r!=="/":r.startsWith(n+"/"),m=(r,n)=>{const d=p.get(r)||[];return d.length===0?!1:d.every(b=>n.has(b)||m(b,n))},i=new Set,C=new Set(t),w=[...t].sort((r,n)=>r.length-n.length);for(const r of w){let n=!1;for(const d of i)if(r!==d&&h(r,d)){n=!0;break}n||(m(r,C),i.add(r))}return i.size===0&&t.length>0&&i.add(t[0]),Array.from(i)},Ye=()=>{const t=oe(),{params:p,back:a}=ve(),{id:u}=p,[s,h]=xe({name:"",description:"",permission_scopes:[],base_path:[]});x([]);const[m,i]=x(0),[C,w]=X(()=>je(parseInt(u))),c=async()=>{if(u){const o=await w();Z(o,f=>{var P,k;h({name:f.name||"",description:f.description||"",permission_scopes:f.permission_scopes||[],base_path:(P=f.permission_scopes)!=null&&P.length?f.permission_scopes.map(R=>R.path):[]}),((k=f.permission_scopes)==null?void 0:k.length)>0&&i(f.permission_scopes[0].permission)})}};Oe(()=>{c()});const r=()=>s.base_path.length===0||s.name.length===0?(re.error(t("users.base_path")+" "+t("global.required")),!1):!0,[n,d]=X(async()=>{const o=W.reduce((k,R,j)=>(m()>>j&1)===1?k|1<<j:k,0),f=await Xe(s.base_path),P={name:s.name,description:s.description,permission_scopes:f.map(k=>({path:k,permission:o}))};return u?Ie({...P,id:parseInt(u)}):Fe(P)}),b=()=>W.filter((o,f)=>(m()>>f&1)===1),S=o=>{const f=1<<o,P=m()^f;i(P),s.base_path&&(P>>o&1?h("permission_scopes",[...s.permission_scopes,{permission:f,path:s.base_path[0]}]):h("permission_scopes",s.permission_scopes.filter(k=>k.permission!==f||k.path!==s.base_path[0])))};return e(L,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(Re,{get children(){return t(u?"global.edit":"global.add")}}),e(De,{get loading(){return C()},get children(){return e(L,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(z,{required:!0,get children(){return[e(B,{get children(){return t("permissions.role.role_name")}}),e(V,{get value(){return s.name},onInput:o=>h("name",o.currentTarget.value)})]}}),e(z,{get children(){return[e(B,{get children(){return t("permissions.role.role_description")}}),e(V,{get value(){return s.description},onInput:o=>h("description",o.currentTarget.value)})]}}),e(z,{required:!0,get children(){return[e(B,{get children(){return t("users.base_path")}}),e(Ve,{id:"base_path",get value(){return s.base_path},onChange:o=>{h("base_path",o)},multiSelect:!0,autoOpen:!!u})]}}),e(z,{get children(){return[e(B,{get children(){return t("permissions.config.permissions_permissions")}}),e(Me,{multiple:!0,get value(){return b()},get children(){return[e(Te,{get children(){return e(F,{display:"flex",flexWrap:"wrap",gap:"$2",pr:"$6",py:"$2",minH:"40px",alignItems:"center",get children(){return e(_,{get when(){return b().length>0},get fallback(){return e(We,{get children(){return t("permissions.config.select_permissions")}})},get children(){return[e(M,{get each(){return b().slice(0,3)},children:(o,f)=>e(E,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return[e(H,{get children(){return t(`users.permissions.${o}`)}}),e(ze,{onClick:P=>{P.stopPropagation(),S(W.indexOf(o))}})]}})}),e(_,{get when(){return b().length>3},get children(){return e(E,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(H,{get children(){return["+",A(()=>b().length-3)]}})}})}})]}})}})}}),e(Be,{get children(){return e(Ee,{get children(){return e(M,{each:W,children:(o,f)=>e(He,{value:o,onClick:()=>S(f()),get children(){return e(q,{spacing:"$2",w:"$full",pl:"$4",fontSize:"$lg",get children(){return[e(le,{get checked(){return(m()>>f()&1)===1},readOnly:!0}),e(Le,{get children(){return t(`users.permissions.${o}`)}})]}})}})})}})}})]}})]}}),e(q,{spacing:"$2",get children(){return[e(J,{get loading(){return n()},onClick:async()=>{if(!r())return;const o=await d();Z(o,()=>{re.success(t("global.save_success")),a()})},get children(){return t("global.save")}}),e(J,{colorScheme:"accent",onClick:()=>a(),get children(){return t("global.back")}})]}})]}})}})]}})};export{Ye as default};
