import{ck as le,a7 as N,x as e,ao as L,an as $,a4 as A,d as j,cg as f,cl as w,r as H,aO as _,bq as m,c2 as ce,cm as ue,cn as ge,co as de,cp as pe,b as he,B as u,cq as be,b9 as E,q as me,ai as z,av as C,aL as fe,bW as W,bX as K,cr as we,S as R,L as P,cs as xe,ct as Ce,aB as _e,am as $e,cu as Se,cv as ve,Q as ke,ah as q,bB as ye,bC as Ie,cw as Fe,aS as Le,n as b,br as Ee,cx as G}from"./index-bcc8ecfe.js";import{a as ze}from"./useTitle-3c2cdb8f.js";import{s as Re,g as Pe,a as Ae}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Be="https://github.com/alist-org/alist";function Oe(o){return le(`${o}-${Be}`)}const Ue=()=>(N("#a9c6ff","#062b74"),e(L,{style:{"background-image":"url(/images/new_bg.png)","background-size":"cover","background-position":"center"},pos:"fixed",top:"0",left:"0",overflow:"hidden",zIndex:"-1",w:"100vw",h:"100vh",get children(){return[e(L,{pos:"absolute",right:{"@initial":"-100px","@sm":"-300px"},top:{"@initial":"-1170px","@sm":"-900px"}}),e(L,{pos:"absolute",left:{"@initial":"-100px","@sm":"-200px"},bottom:{"@initial":"-760px","@sm":"-400px"}})]}})),De=()=>{const o=$("sso_login_enabled"),S=A("sso_login_platform"),s=$("sso_compatibility_mode"),{searchParams:d,to:i}=j(),p=d.token;p!=null&&p!=""&&(f(p),i(decodeURIComponent(d.redirect||w||"/"),!0));function l(h){const n=h.data;n.token&&(f(n.token),i(decodeURIComponent(d.redirect||w||"/"),!0))}if(window.addEventListener("message",l),H(()=>{window.removeEventListener("message",l)}),o){const h=()=>{const x=m.getUri()+"/auth/sso?method=sso_get_token";if(s){window.location.href=x;return}window.open(x,"authPopup","width=500,height=600")};let n;switch(S){case"Github":n=pe;break;case"Microsoft":n=de;break;case"Google":n=ge;break;case"Dingtalk":n=ue;break;default:n=ce}return e(_,{cursor:"pointer",boxSize:"$8",as:n,p:"$0_5",onclick:h})}},qe=()=>{const o=he();ze("密码登录");const S=N("white","$neutral1"),[s,d]=u(localStorage.getItem("username")||""),[i,p]=u(localStorage.getItem("password")||""),[l,h]=u(!1),[n,x]=u(""),[v,J]=u(!1),[B,Me]=be("remember-pwd","false"),[V,Q]=u(!1),[X,Y]=E(async()=>V()?m.post("/auth/login/ldap",{username:s(),password:i(),otp_code:n()}):m.post("/auth/login/hash",{username:s(),password:Oe(i()),otp_code:n()})),[,Z]=E((t,r,g,F)=>m.post("/authn/webauthn_finish_login?username="+g,JSON.stringify(r),{headers:{session:t},signal:F})),[,ee]=E((t,r)=>m.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:k,to:y}=j(),te=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,O=$("webauthn_login_enabled"),oe=async()=>{J(!v())};let a=null;const U=async t=>{if(!Re()){t||b.error(o("users.webauthn_not_supported"));return}if(t&&!await te())return;a==null||a.abort();const r=new AbortController;a=r;const g=t?"":s();!t&&B()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const F=await ee(g,r.signal);Ee(F,async T=>{try{const c=Pe(T.options);c.signal=r.signal,t&&(c.mediation="conditional");const ae=await Ae(c),se=await Z(T.session,ae,g,r.signal);G(se,ie=>{b.success(o("login.success")),f(ie.token),y(decodeURIComponent(k.redirect||w||"/"),!0)})}catch(c){c instanceof Error&&c.name!="AbortError"&&b.error(c.message)}})},D=()=>a==null?void 0:a.abort();me(()=>{O&&(window.addEventListener("beforeunload",D),U(!0))}),H(()=>{a==null||a.abort(),window.removeEventListener("beforeunload",D)});const I=async()=>{if(v())await U();else{B()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await Y();G(t,r=>{b.success(o("login.success")),f(r.token),y(decodeURIComponent(k.redirect||w||"/"),!0)},(r,g)=>{!M()&&g===402?ne(!0):b.error(r)})}},[M,ne]=u(!1),re=$("ldap_login_enabled");return A("ldap_login_tips"),re&&Q(!0),e(Le,{zIndex:"1",w:"$full",h:"100vh",get children(){return[e(z,{spacing:"$6",alignItems:"center",get children(){return[e(C,{alignItems:"center",spacing:"$2",get children(){return[e(fe,{boxSize:"$10",get src(){return A("logo").split(`
`)[0]},alt:"AList Logo"}),e(W,{color:"#3573FF",fontSize:"42px",fontWeight:"bold",children:"AList"})]}}),e(z,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"420px"},spacing:"$4",get children(){return[e(K,{alignItems:"center",justifyContent:"center",get children(){return e(W,{color:"#3573FF",fontSize:"18px",get children(){return o("login.password_login")}})}}),e(we,{borderColor:"#E9E9E9"}),e(R,{get when(){return!M()},get fallback(){return e(P,{id:"totp",name:"otp",get placeholder(){return o("login.otp-tips")},get value(){return n()},onInput:t=>x(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&I()}})},get children(){return[e(C,{w:"$full",border:"1px solid",borderColor:"$neutral6",borderRadius:"12px",px:"$3",spacing:"$2",alignItems:"center",_focusWithin:{borderColor:"$primary6",boxShadow:"0 0 0 1px $colors$primary6"},get children(){return[e(_,{as:xe,color:"$neutral8",boxSize:"$5"}),e(P,{name:"username",placeholder:"请输入账号",get value(){return s()},onInput:t=>d(t.currentTarget.value),border:"none",bgColor:"transparent",_focus:{border:"none",boxShadow:"none",bgColor:"transparent"},_hover:{border:"none",boxShadow:"none",bgColor:"transparent"},flex:1})]}}),e(R,{get when(){return!v()},get children(){return e(C,{w:"$full",border:"1px solid",borderColor:"$neutral6",borderRadius:"12px",px:"$3",spacing:"$2",alignItems:"center",_focusWithin:{borderColor:"$primary6",boxShadow:"0 0 0 1px $colors$primary6"},get children(){return[e(_,{as:Ce,color:"$neutral8",boxSize:"$5"}),e(P,{name:"password",placeholder:"请输入密码",get type(){return l()?"text":"password"},get value(){return i()},onInput:t=>p(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&I()},border:"none",bgColor:"transparent",_focus:{border:"none",boxShadow:"none",bgColor:"transparent"},_hover:{border:"none",boxShadow:"none",bgColor:"transparent"},flex:1}),e(_e,{size:"md",variant:"ghost",get icon(){return $e(()=>!!l(),!0)()?e(Se,{}):e(ve,{})},onClick:()=>h(!l()),color:"$neutral8",get"aria-label"(){return l()?"隐藏密码":"显示密码"},_hover:{backgroundColor:"$neutral3"}})]}})}})]}}),e(z,{w:"$full",spacing:"$4",get children(){return[e(ke,{w:"$full",get loading(){return X()},onClick:I,bgColor:"#3573FF",color:"white",_hover:{backgroundColor:"#2B5CD9"},_active:{backgroundColor:"#1E40AF"},h:"45px",fontSize:"16px",fontWeight:"bold",borderRadius:"12px",mt:"$5",get children(){return o("login.login")}}),e(C,{w:"$full",justifyContent:"space-between",alignItems:"center",get children(){return[e(q,{as:"a",target:"_blank",get href(){return o("login.forget_url")},color:"#3573FF",fontSize:"14px",cursor:"pointer",_hover:{textDecoration:"underline"},get children(){return o("login.forget")}}),e(q,{as:"a",onClick:()=>{f(),y(decodeURIComponent(k.redirect||w||"/"),!0)},color:"#3573FF",fontSize:"14px",cursor:"pointer",_hover:{textDecoration:"underline"},get children(){return o("login.use_guest")}})]}})]}}),e(K,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(ye,{}),e(Ie,{}),e(De,{}),e(R,{when:O,get children(){return e(_,{cursor:"pointer",boxSize:"$8",as:Fe,p:"$0_5",onclick:oe})}})]}})]}})]}}),e(Ue,{})]}})};export{qe as default};
