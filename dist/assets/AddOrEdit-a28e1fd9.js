import{a$ as ae,b as le,B as x,H as G,x as e,L as X,ao as R,S as y,ah as z,W as B,d_ as L,d$ as A,aZ as be,ai as q,am as J,M as ie,I as ce,bw as Se,J as ue,av as K,K as de,O as ge,Q as M,R as he,dL as we,dA as $e,dI as Ce,A as re,bb as Z,e2 as N,_ as ee,dJ as Pe,D as _e,bd as fe,dK as ke,aC as Y,aP as se,$ as ye,i as ve,bt as te,d as xe,cP as je,e1 as Ie,q as Oe,aY as E,e3 as Fe,e4 as Me,bY as Re,ap as De,bT as H,bG as W,bI as Te,bJ as ze,bK as Be,e0 as Ee,bN as He,bO as We,bP as Le,bQ as Ae,n as oe,j as qe,bs as Je}from"./index-e047d5a8.js";import{o as Ke,j as Qe}from"./index-023d1aa9.js";const Ue=(t,b,i)=>{const f=t.join("/");if(console.log("计算节点状态:",{当前路径:f,选中路径:b,子节点:i}),b.some(a=>{const S=a.join("/")===f;return S&&console.log("节点直接选中:",f),S}))return{checked:!0,indeterminate:!1};if(!(i!=null&&i.length))return b.some($=>$.join("/").startsWith(f+"/"))?(console.log("是选中路径的父节点:",f),{checked:!1,indeterminate:!0}):{checked:!1,indeterminate:!1};let o=0,m=!1;return i.forEach(a=>{const S=[...t,a.name].join("/"),c=b.some(n=>n.join("/")===S),r=b.some(n=>n.join("/").startsWith(S+"/"));c?o++:r&&(m=!0)}),console.log("子节点状态:",{路径:f,选中数:o,总数:i.length,有半选:m}),o===i.length?{checked:!0,indeterminate:!1}:o>0||m?{checked:!1,indeterminate:!0}:{checked:!1,indeterminate:!1}},me=t=>{const{isHidePath:b}=$e(),[i,f]=x(),[g,o]=x(!1),{value:m,onChange:a,forceRoot:$,autoOpen:S,showEmptyIcon:c,showHiddenFolder:r,selectedPaths:n,onSelect:u,multiSelect:C}=Ce(ne),w=re(()=>{if(!n||!n())return{checked:!1,indeterminate:!1};const l=Ue(t.segments,n(),i());return console.log("节点状态计算:",{path:t.segments.join("/"),state:l,selectedPaths:n(),children:i()}),l});re(()=>{if(!n||!n())return!1;const l=n(),h=t.segments.join("/"),k=l.some(_=>{const F=_.join("/");return h===""?_.length===1:F.startsWith(h+"/")&&F.split("/").length===h.split("/").length+1}),v=l.some(_=>_.join("/").startsWith(h+"/"));return console.log("检查选中子节点:",{当前路径:h,有直接子节点:k,有深层子节点:v,选中路径:l}),k||v});const j=async(l,h)=>{if(l.stopPropagation(),C&&u){const k=!w().checked;let v=[];if(i())v=i().map(_=>[...h,_.name]);else try{const _=await N("/"+h.join("/"),ee(),!0);_.code===200&&(v=_.data.map(F=>[...h,F.name]))}catch(_){console.error("获取子节点失败:",_)}u(h,k,v)}else a("/"+h.join("/"));console.log(`========== 节点点击结束 ==========
`)},Q=()=>{var l;return!!(c&&i()!==void 0&&!((l=i())!=null&&l.length))},[U,V]=Z(()=>N(t.segments.join("/"),ee(),$));let I=!1;const O=async()=>{var h,k;if((h=i())!=null&&h.length)return;const l=await V();if(l.code===500&&((k=l.message)!=null&&k.includes("storage not found; please add a storage first"))){f([]);return}te(l,v=>{I=!0,f(v)},()=>{s()&&d()})},{isOpen:s,onToggle:d}=ae(),p=()=>m()===t.segments.join("/"),P=Pe(t.segments.join("/")),D=l=>{l.stopPropagation(),s()?o(!0):(o(!1),O()),d()};G(()=>{const l=t.segments.length,h=n==null?void 0:n(),k=t.segments.join("/");(()=>g()?!1:!!(l===0&&(h!=null&&h.length)||l<3&&(h!=null&&h.some(_=>_.join("/").startsWith(k+"/")))))()&&!s()&&(console.log("展开节点:",k),d(),O())}),G(_e(m,async l=>{t.segments.length>=3||S&&P(l)&&(s()||d(),I||O())}));const pe=()=>b(t.segments.join("/"))&&!P(m());return e(y,{get when(){return r||!pe()},get children(){return e(R,{get children(){return[e(K,{spacing:"$2",alignItems:"center",get children(){return[e(y,{when:C,get children(){return e(R,{get children(){return e(fe,{get checked(){return w().checked},get indeterminate(){return w().indeterminate}})}})}}),e(y,{get when(){return!U()},get fallback(){return e(ke,{size:"sm",get color(){return Y()}})},get children(){return e(y,{get when(){return!Q()},get fallback(){return e(se,{get color(){return Y()},as:Ke})},get children(){return e(se,{get color(){return Y()},as:Qe,get transform(){return s()?"rotate(90deg)":"none"},transition:"transform 0.2s",cursor:"pointer",onClick:D})}})}}),e(z,{css:{whiteSpace:"nowrap"},fontSize:"$md",cursor:"pointer",px:"$1",rounded:"$md",get bgColor(){return p()?"$info8":"transparent"},get _hover(){return{backgroundColor:p()?"$info8":ye()}},onClick:l=>{l.stopPropagation(),j(l,t.segments)},get children(){return J(()=>t.segments.join("/")==="",!0)()?"root":ve(t.segments.join("/"))}})]}}),e(y,{get when(){return s()},get children(){return e(q,{mt:"$1",pl:"$4",alignItems:"start",spacing:"$1",get children(){return e(B,{get each(){return i()},children:l=>e(me,{get segments(){return[...t.segments,l.name]}})})}})}})]}})}})},ne=we(),Ve=t=>{var g;const[b,i]=x("/");(g=t.handle)==null||g.call(t,{setPath:i});const f=t.selectedPaths;return e(R,{class:"folder-tree-box",w:"$full",overflowX:"auto",get children(){return e(ne.Provider,{get value(){return{value:b,onChange:o=>{i(o),t.onChange(o)},autoOpen:t.autoOpen??!1,forceRoot:t.forceRoot??!1,showEmptyIcon:t.showEmptyIcon??!1,showHiddenFolder:t.showHiddenFolder??!0,multiSelect:t.multiSelect,selectedPaths:f,onSelect:t.onSelect}},get children(){return e(me,{segments:[]})}})}})},Ye=t=>{const{isOpen:b,onOpen:i,onClose:f}=ae(),g=le(),[o,m]=x(t.value.map(c=>c.split("/").filter(Boolean))),[a,$]=x(t.value.map(c=>c.split("/").filter(Boolean)));G(()=>{if(t.value){const c=t.value.map(r=>r.split("/").filter(Boolean));m(c),$(c)}});const S=async(c,r,n)=>{console.log("选择处理开始:",{segments:c,checked:r,childPaths:n,当前选中:o(),当前显示:a()});let u=[...o()];const C=c.join("/");r?(c.length>0&&!u.some(w=>w.join("/")===C)&&u.push(c),n&&n.forEach(w=>{u.some(j=>j.join("/")===w.join("/"))||u.push(w)})):c.length===0?u=[]:u=u.filter(w=>{const j=w.join("/");return j!==C&&!j.startsWith(C+"/")}),m(u),$(u),t.onChange(u.map(w=>w.length===0?"/":"/"+w.join("/")))};return[e(R,{w:"$full",position:"relative",get children(){return[e(X,{get id(){return t.id},readOnly:!0,h:"44px",pl:"$4",pointerEvents:"none",_focus:{border:"none",boxShadow:"none"}}),e(R,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",display:"flex",alignItems:"center",flexWrap:"wrap",gap:"$2",maxW:"90%",pl:"$4",cursor:"pointer",onClick:i,zIndex:1,get children(){return e(y,{get when(){return a().length>0},get fallback(){return e(z,{color:"$neutral10",get children(){return g("global.choose_folder")}})},get children(){return[e(B,{get each(){return a().slice(0,3)},children:c=>{const r="/"+c.join("/");return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",maxW:"300px",title:r,get children(){return e(A,{css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:r})}})}}),e(y,{get when(){return a().length>3},get children(){return e(be,{placement:"bottom",withArrow:!0,closeDelay:0,get label(){return e(q,{alignItems:"flex-start",spacing:"$1",get children(){return e(B,{get each(){return a().slice(3)},children:c=>e(z,{fontSize:"$sm",color:"$neutral8",css:{wordBreak:"break-all"},get children(){return"/"+c.join("/")}})})}})},get children(){return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(A,{get children(){return["+",J(()=>a().length-3)]}})}})}})}})]}})}})]}}),e(he,{size:"xl",get opened(){return b()},onClose:f,get children(){return[e(ie,{}),e(ce,{get children(){return[e(Se,{}),e(ue,{get children(){return e(K,{spacing:"$2",alignItems:"center",get children(){return[e(z,{fontWeight:"bold",get children(){return g("global.choose_folder")}}),e(z,{fontSize:"$sm",get children(){return["（",J(()=>g("global.please_click_to_select")),"）"]}})]}})}}),e(de,{get children(){return e(ne.Provider,{get value(){return{value:()=>"/",onChange:c=>{},forceRoot:!0,autoOpen:t.autoOpen??!1,showEmptyIcon:!1,showHiddenFolder:!0,selectedPaths:a,onSelect:S,multiSelect:t.multiSelect}},get children(){return e(Ve,{forceRoot:!0,onChange:c=>{},get multiSelect(){return t.multiSelect},selectedPaths:a,onSelect:S,get autoOpen(){return t.autoOpen}})}})}}),e(ge,{get children(){return[e(M,{colorScheme:"neutral",onClick:f,mr:"$2",get children(){return g("global.cancel")}}),e(M,{onClick:f,get children(){return g("global.confirm")}})]}})]}})]}})]},Ge=async t=>{const b=new Map,i=async r=>{try{const n=await N(r,ee(),!0);if(n.code===200)return n.data.map(C=>qe(r,C.name))}catch(n){console.error(`获取目录 [${r}] 内容失败:`,n)}return[]},f=r=>{if(r==="/"||!r.includes("/"))return"";const n=r.lastIndexOf("/");return n===0?"/":r.substring(0,n)},g=new Set;t.forEach(r=>g.add(r)),t.forEach(r=>{let n=f(r);for(;n!=="";)g.add(n),n=f(n)});for(const r of g)if(!b.has(r)){const n=await i(r);b.set(r,n)}const o=(r,n)=>n==="/"?r!=="/":r.startsWith(n+"/"),m=(r,n)=>{const u=b.get(r)||[];return u.length===0?!1:u.every(C=>n.has(C)||m(C,n))},a=new Set,$=new Set(t),S=[...t].sort((r,n)=>r.length-n.length);for(const r of S){let n=!1;for(const u of a)if(r!==u&&o(r,u)){n=!0;break}n||(m(r,$),a.add(r))}return a.size===0&&t.length>0&&a.add(t[0]),Array.from(a)},Ne=()=>{const t=le(),{params:b,back:i,to:f}=xe(),{id:g}=b,[o,m]=je({name:"",description:"",permission_scopes:[],base_path:[]});x([]);const[a,$]=x(0),[S,c]=x(!1),[r,n]=x(!1),u=async()=>{var s;try{const d=await Je.get("/fs/list");return d.code===500&&((s=d.message)!=null&&s.includes("please add a storage first"))?(n(!0),!1):!0}catch(d){return console.error("Failed to check storage:",d),!1}},[C,w]=Z(()=>Ie(parseInt(g))),j=async()=>{const s=await u();if(c(s),!!s&&g){const d=await w();te(d,p=>{var P,D;m({name:p.name||"",description:p.description||"",permission_scopes:p.permission_scopes||[],base_path:(P=p.permission_scopes)!=null&&P.length?p.permission_scopes.map(T=>T.path):[]}),((D=p.permission_scopes)==null?void 0:D.length)>0&&$(p.permission_scopes[0].permission)})}};Oe(()=>{j()});const Q=()=>o.base_path.length===0||o.name.length===0?(oe.error(t("users.base_path")+" "+t("global.required")),!1):!0,[U,V]=Z(async()=>{const s=E.reduce((P,D,T)=>(a()>>T&1)===1?P|1<<T:P,0),d=await Ge(o.base_path),p={name:o.name,description:o.description,permission_scopes:d.map(P=>({path:P,permission:s}))};return g?Fe({...p,id:parseInt(g)}):Me(p)}),I=()=>E.filter((s,d)=>(a()>>d&1)===1),O=s=>{const d=1<<s,p=a()^d;$(p),o.base_path&&(p>>s&1?m("permission_scopes",[...o.permission_scopes,{permission:d,path:o.base_path[0]}]):m("permission_scopes",o.permission_scopes.filter(P=>P.permission!==d||P.path!==o.base_path[0])))};return e(q,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(Re,{get children(){return t(g?"global.edit":"global.add")}}),e(De,{get loading(){return C()},get children(){return e(y,{get when(){return S()},get children(){return e(q,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(H,{required:!0,get children(){return[e(W,{get children(){return t("permissions.role.role_name")}}),e(X,{get value(){return o.name},onInput:s=>m("name",s.currentTarget.value)})]}}),e(H,{get children(){return[e(W,{get children(){return t("permissions.role.role_description")}}),e(X,{get value(){return o.description},onInput:s=>m("description",s.currentTarget.value)})]}}),e(H,{required:!0,get children(){return[e(W,{get children(){return t("users.base_path")}}),e(Ye,{id:"base_path",get value(){return o.base_path},onChange:s=>{m("base_path",s)},multiSelect:!0,autoOpen:!!g})]}}),e(H,{get children(){return[e(W,{get children(){return t("permissions.config.permissions_permissions")}}),e(Te,{multiple:!0,get value(){return I()},get children(){return[e(ze,{get children(){return e(R,{display:"flex",flexWrap:"wrap",gap:"$2",pr:"$6",py:"$2",minH:"40px",alignItems:"center",get children(){return e(y,{get when(){return I().length>0},get fallback(){return e(Be,{get children(){return t("permissions.config.select_permissions")}})},get children(){return[e(B,{get each(){return I().slice(0,3)},children:(s,d)=>e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return[e(A,{get children(){return t(`users.permissions.${s}`)}}),e(Ee,{onClick:p=>{p.stopPropagation(),O(E.indexOf(s))}})]}})}),e(y,{get when(){return I().length>3},get children(){return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(A,{get children(){return["+",J(()=>I().length-3)]}})}})}})]}})}})}}),e(He,{get children(){return e(We,{get children(){return e(B,{each:E,children:(s,d)=>e(Le,{value:s,onClick:()=>O(d()),get children(){return e(K,{spacing:"$2",w:"$full",pl:"$4",fontSize:"$lg",get children(){return[e(fe,{get checked(){return(a()>>d()&1)===1},readOnly:!0}),e(Ae,{get children(){return t(`users.permissions.${s}`)}})]}})}})})}})}})]}})]}}),e(K,{spacing:"$2",get children(){return[e(M,{get loading(){return U()},onClick:async()=>{if(!Q())return;const s=await V();te(s,()=>{oe.success(t("global.save_success")),i()})},get children(){return t("global.save")}}),e(M,{colorScheme:"accent",onClick:()=>i(),get children(){return t("global.back")}})]}})]}})}})}}),e(he,{get opened(){return r()},onClose:()=>n(!1),get children(){return[e(ie,{}),e(ce,{get children(){return[e(ue,{}),e(de,{get children(){return t("storages.no_storage_content")}}),e(ge,{get children(){return[e(M,{colorScheme:"accent",onClick:()=>n(!1),get children(){return t("global.cancel")}}),e(M,{onClick:()=>{n(!1),f("/@manage/storages")},ml:"$2",get children(){return t("home.go_to_storages")}})]}})]}})]}})]}})};export{Ne as default};
