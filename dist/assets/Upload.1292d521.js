import{bj as J,_ as M,o as V,d as W,u as Y,e as P,bI as q,f as o,m as S,a0 as U,B as L,v as N,I as O,W as R,a7 as _,n as Q,br as j,Y as X,aS as Z,a6 as H,bH as E,aP as T,bJ as ee,ai as te,bK as ae,bL as oe,bM as re,p as ne}from"./index.2e73a62d.js";import{a as se,b as le}from"./index.6576c5b7.js";async function*ce(a,d,i){const r=new Set;async function u(){const[p,n]=await Promise.race(r);return r.delete(p),n}for(const p of d){const n=(async()=>await i(p,d))().then(c=>[n,c]);r.add(n),r.size>=a&&(yield await u())}for(;r.size;)yield await u()}const ie={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},de=async a=>{let d=[];const i=async(r,u)=>{await new Promise((n,c)=>{const s=l=>{console.error(l),c(l)};r.isFile?r.file(l=>{const m=new File([l],u+l.name,{type:l.type});d.push(m),console.log(m),n({})},s):r.isDirectory&&r.createReader().readEntries(async m=>{for(let g=0;g<m.length;g++)await i(m[g],u+r.name+"/");n({})},s)})};return await i(a,""),d},ue=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),pe=async(a,d,i,r=!1)=>{let u=new Date().valueOf(),p=0;const n=new FormData;n.append("file",d);const c=await J.put("/fs/form",n,{headers:{"File-Path":encodeURIComponent(a),"As-Task":r,"Content-Type":"multipart/form-data",Password:M()},onUploadProgress:s=>{if(s.total){const l=s.loaded/s.total*100|0;i("progress",l);const m=new Date().valueOf(),g=(m-u)/1e3;if(g>1){const k=(s.loaded-p)/g,F=(s.total-s.loaded)/k;i("speed",k),console.log(F),u=m,p=s.loaded}l===100&&i("status","backending")}}});if(c.code!==200)return new Error(c.message)},me=async(a,d,i,r=!1)=>{let u=new Date().valueOf(),p=0;const n=await J.put("/fs/put",d,{headers:{"File-Path":encodeURIComponent(a),"As-Task":r,"Content-Type":d.type||"application/octet-stream",Password:M()},onUploadProgress:c=>{if(c.total){const s=c.loaded/c.total*100|0;i("progress",s);const l=new Date().valueOf(),m=(l-u)/1e3;if(m>1){const b=(c.loaded-p)/m,f=(c.total-c.loaded)/b;i("speed",b),console.log(f),u=l,p=c.loaded}s===100&&i("status","backending")}}});if(n.code!==200)return new Error(n.message)},ge=[{name:"Stream",upload:me,provider:/.*/},{name:"Form",upload:pe,provider:/.*/}],fe=()=>ge.filter(a=>a.provider.test(V.provider)),he=a=>{const d=W();return o(R,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${_()}`}},get children(){return[o(T,{css:{wordBreak:"break-all"},get children(){return a.path}}),o(U,{spacing:"$2",get children(){return[o(ee,{get colorScheme(){return ie[a.status]},get children(){return d(`home.upload.${a.status}`)}}),o(T,{get children(){return[te(()=>ae(a.speed)),"/s"]}})]}}),o(oe,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return o(re,{get color(){return _()},rounded:"$md"})}}),o(T,{color:"$danger10",get children(){return a.msg}})]}})},ke=()=>{const a=W(),{pathname:d}=Y(),[i,r]=P(!1),[u,p]=P(!1),[n,c]=P(!1),[s,l]=q({uploads:[]}),m=()=>s.uploads.every(({status:e})=>["success","error"].includes(e));let g,b;const k=async e=>{if(e.length!==0){p(!0);for(const t of e){const w=ue(t);l("uploads",h=>[...h,w])}for await(const t of ce(3,e,K))console.log(t)}},f=(e,t,w)=>{l("uploads",h=>h.path===e,t,w)},F=fe(),[v,G]=P(F[0]),K=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;f(t,"status","uploading");const w=ne(d(),t);try{const h=await v().upload(w,e,(D,C)=>{f(t,D,C)},n());h?(f(t,"status","error"),f(t,"msg",h.message)):(f(t,"status","success"),f(t,"progress",100))}catch(h){console.error(h),f(t,"status","error"),f(t,"msg",h.message)}};return o(R,{w:"$full",pb:"$2",spacing:"$2",get children(){return o(S,{get when(){return!u()},get fallback(){return[o(U,{spacing:"$2",get children(){return[o(L,{colorScheme:"accent",onClick:()=>{l("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t))),console.log(s.uploads)},get children(){return a("home.upload.clear_done")}}),o(S,{get when(){return m()},get children(){return o(L,{onClick:()=>{p(!1)},get children(){return a("home.upload.back")}})}})]}}),o(N,{get each(){return s.uploads},children:e=>o(he,e)})]},get children(){return[o(O,{type:"file",multiple:!0,ref(e){const t=g;typeof t=="function"?t(e):g=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),o(O,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=b;typeof t=="function"?t(e):b=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),o(R,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${i()?_():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),r(!0)},onDragLeave:()=>{r(!1)},onDrop:async e=>{var x,A,I,z;e.preventDefault(),e.stopPropagation(),r(!1);const t=[],w=Array.from((A=(x=e.dataTransfer)==null?void 0:x.items)!=null?A:[]),h=Array.from((z=(I=e.dataTransfer)==null?void 0:I.files)!=null?z:[]);let D=w.length;const C=[];for(let $=0;$<D;$++){const y=w[$].webkitGetAsEntry();y!=null&&y.isFile?t.push(h[$]):y!=null&&y.isDirectory&&C.push(y)}for(const $ of C){const B=await de($);t.push(...B)}t.length===0&&Q.warning(a("home.upload.no_files_drag")),k(t)},spacing:"$4",h:"$56",get children(){return o(S,{get when(){return!i()},get fallback(){return o(j,{get children(){return a("home.upload.release")}})},get children(){return[o(j,{get children(){return a("home.upload.upload-tips")}}),o(X,{w:"30%",get children(){return o(Z,{get value(){return v().name},onChange:e=>{G(F.find(t=>t.name===e))},get options(){return F.map(e=>({label:e.name,value:e.name}))}})}}),o(U,{spacing:"$4",get children(){return[o(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return o(se,{})},onClick:()=>{b.click()}}),o(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return o(le,{})},onClick:()=>{g.click()}})]}}),o(E,{get checked(){return n()},onChange:()=>{c(!n())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{ke as default};
