import{a$ as ae,b as le,B as y,H as Y,x as e,L as Z,ao as M,S as _,ah as T,W as z,dp as L,dq as A,aZ as pe,ai as q,am as J,M as ie,I as ce,bz as Se,J as ue,av as Q,K as de,O as ge,Q as R,R as he,dS as be,dO as we,dP as $e,A as re,be as G,ed as N,_ as ee,dQ as Ce,D as Pe,bg as fe,dR as ke,aC as X,aP as se,$ as _e,i as ye,bw as te,d as ve,cW as xe,ec as je,q as Oe,aY as W,ee as Ie,ef as Fe,c2 as Re,ap as Me,bW as E,bJ as H,bL as De,bM as Te,bN as ze,dr as Be,bQ as We,bR as Ee,bS as He,bT as Le,n as oe,j as Ae,bv as qe}from"./index-6ba85c96.js";import{r as Je,l as Qe}from"./index-b8fadc74.js";const Ue=(t,m,l)=>{const h=t.join("/");if(console.log("计算节点状态:",{当前路径:h,选中路径:m,子节点:l}),m.some(a=>{const w=a.join("/")===h;return w&&console.log("节点直接选中:",h),w}))return{checked:!0,indeterminate:!1};if(!(l!=null&&l.length))return m.some($=>$.join("/").startsWith(h+"/"))?(console.log("是选中路径的父节点:",h),{checked:!1,indeterminate:!0}):{checked:!1,indeterminate:!1};let s=0,f=!1;return l.forEach(a=>{const w=[...t,a.name].join("/"),i=m.some(n=>n.join("/")===w),r=m.some(n=>n.join("/").startsWith(w+"/"));i?s++:r&&(f=!0)}),console.log("子节点状态:",{路径:h,选中数:s,总数:l.length,有半选:f}),s===l.length?{checked:!0,indeterminate:!1}:s>0||f?{checked:!1,indeterminate:!0}:{checked:!1,indeterminate:!1}},me=t=>{const{isHidePath:m}=we(),[l,h]=y(),[d,s]=y(!1),{value:f,onChange:a,forceRoot:$,autoOpen:w,showEmptyIcon:i,showHiddenFolder:r,selectedPaths:n,onSelect:u,multiSelect:C}=$e(ne),S=re(()=>{if(!n||!n())return{checked:!1,indeterminate:!1};const c=Ue(t.segments,n(),l());return console.log("节点状态计算:",{path:t.segments.join("/"),state:c,selectedPaths:n(),children:l()}),c});re(()=>{if(!n||!n())return!1;const c=n(),b=t.segments.join("/"),I=c.some(k=>{const D=k.join("/");return b===""?k.length===1:D.startsWith(b+"/")&&D.split("/").length===b.split("/").length+1}),O=c.some(k=>k.join("/").startsWith(b+"/"));return console.log("检查选中子节点:",{当前路径:b,有直接子节点:I,有深层子节点:O,选中路径:c}),I||O});const v=async(c,b)=>{if(c.stopPropagation(),C&&u){const I=!S().checked;let O=[];if(l())O=l().map(k=>[...b,k.name]);else try{const k=await N("/"+b.join("/"),ee(),!0);k.code===200&&(O=k.data.map(D=>[...b,D.name]))}catch(k){console.error("获取子节点失败:",k)}u(b,I,O)}else a("/"+b.join("/"))},U=()=>{var c;return!!(i&&l()!==void 0&&!((c=l())!=null&&c.length))},[V,K]=G(()=>N(t.segments.join("/"),ee(),$)),x=async()=>{var b,I;if((b=l())!=null&&b.length)return;const c=await K();if(c.code===500&&((I=c.message)!=null&&I.includes("storage not found; please add a storage first"))){h([]);return}te(c,O=>{h(O)},()=>{j()&&o()})},{isOpen:j,onToggle:o}=ae(),g=()=>f()===t.segments.join("/"),p=Ce(t.segments.join("/")),P=c=>{c.stopPropagation(),j()?s(!0):(s(!1),x()),o()};Y(()=>{t.segments.length,n==null||n();const c=t.segments.join("/");(()=>(d(),!1))()&&!j()&&(console.log("展开节点:",c),o(),x())}),Y(Pe(f,async c=>{}));const F=()=>m(t.segments.join("/"))&&!p(f());return e(_,{get when(){return r||!F()},get children(){return e(M,{get children(){return[e(Q,{spacing:"$2",alignItems:"center",get children(){return[e(_,{when:C,get children(){return e(M,{get children(){return e(fe,{get checked(){return S().checked},get indeterminate(){return S().indeterminate}})}})}}),e(_,{get when(){return!V()},get fallback(){return e(ke,{size:"sm",get color(){return X()}})},get children(){return e(_,{get when(){return!U()},get fallback(){return e(se,{get color(){return X()},as:Je})},get children(){return e(se,{get color(){return X()},as:Qe,get transform(){return j()?"rotate(90deg)":"none"},transition:"transform 0.2s",cursor:"pointer",onClick:P})}})}}),e(T,{css:{whiteSpace:"nowrap"},fontSize:"$md",cursor:"pointer",px:"$1",rounded:"$md",get bgColor(){return g()?"$info8":"transparent"},get _hover(){return{backgroundColor:g()?"$info8":_e()}},onClick:c=>{c.stopPropagation(),v(c,t.segments)},get children(){return J(()=>t.segments.join("/")==="",!0)()?"root":ye(t.segments.join("/"))}})]}}),e(_,{get when(){return j()},get children(){return e(q,{mt:"$1",pl:"$4",alignItems:"start",spacing:"$1",get children(){return e(z,{get each(){return l()},children:c=>e(me,{get segments(){return[...t.segments,c.name]}})})}})}})]}})}})},ne=be(),Ve=t=>{var d;const[m,l]=y("/");(d=t.handle)==null||d.call(t,{setPath:l});const h=t.selectedPaths;return e(M,{class:"folder-tree-box",w:"$full",overflowX:"auto",get children(){return e(ne.Provider,{get value(){return{value:m,onChange:s=>{l(s),t.onChange(s)},autoOpen:t.autoOpen??!1,forceRoot:t.forceRoot??!1,showEmptyIcon:t.showEmptyIcon??!1,showHiddenFolder:t.showHiddenFolder??!0,multiSelect:t.multiSelect,selectedPaths:h,onSelect:t.onSelect}},get children(){return e(me,{segments:[]})}})}})},Ke=t=>{const{isOpen:m,onOpen:l,onClose:h}=ae(),d=le(),[s,f]=y(t.value.map(i=>i.split("/").filter(Boolean))),[a,$]=y(t.value.map(i=>i.split("/").filter(Boolean)));Y(()=>{if(t.value){const i=t.value.map(r=>r.split("/").filter(Boolean));f(i),$(i)}});const w=async(i,r,n)=>{console.log("选择处理开始:",{segments:i,checked:r,childPaths:n,当前选中:s(),当前显示:a()});let u=[...s()];const C=i.join("/");r?i.length===0?u=[[]]:(u.some(S=>S.join("/")===C)||u.push(i),n&&n.forEach(S=>{u.some(v=>v.join("/")===S.join("/"))||u.push(S)})):i.length===0?u=[]:u=u.filter(S=>{const v=S.join("/");return v!==C&&!v.startsWith(C+"/")}),f(u),$(u),t.onChange(u.map(S=>S.length===0?"/":"/"+S.join("/")))};return[e(M,{w:"$full",position:"relative",get children(){return[e(Z,{get id(){return t.id},readOnly:!0,h:"44px",pl:"$4",pointerEvents:"none",_focus:{border:"none",boxShadow:"none"}}),e(M,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",display:"flex",alignItems:"center",flexWrap:"wrap",gap:"$2",maxW:"90%",pl:"$4",cursor:"pointer",onClick:l,zIndex:1,get children(){return e(_,{get when(){return a().length>0},get fallback(){return e(T,{color:"$neutral10",get children(){return d("global.choose_folder")}})},get children(){return[e(z,{get each(){return a().slice(0,3)},children:i=>{const r="/"+i.join("/");return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",maxW:"300px",title:r,get children(){return e(A,{css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:r})}})}}),e(_,{get when(){return a().length>3},get children(){return e(pe,{placement:"bottom",withArrow:!0,closeDelay:0,get label(){return e(q,{alignItems:"flex-start",spacing:"$1",get children(){return e(z,{get each(){return a().slice(3)},children:i=>e(T,{fontSize:"$sm",color:"$neutral8",css:{wordBreak:"break-all"},get children(){return"/"+i.join("/")}})})}})},get children(){return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(A,{get children(){return["+",J(()=>a().length-3)]}})}})}})}})]}})}})]}}),e(he,{size:"xl",get opened(){return m()},onClose:h,get children(){return[e(ie,{}),e(ce,{get children(){return[e(Se,{}),e(ue,{get children(){return e(Q,{spacing:"$2",alignItems:"center",get children(){return[e(T,{fontWeight:"bold",get children(){return d("global.choose_folder")}}),e(T,{fontSize:"$sm",get children(){return["（",J(()=>d("global.please_click_to_select")),"）"]}})]}})}}),e(de,{get children(){return e(ne.Provider,{get value(){return{value:()=>"/",onChange:i=>{},forceRoot:!0,autoOpen:t.autoOpen??!1,showEmptyIcon:!1,showHiddenFolder:!0,selectedPaths:a,onSelect:w,multiSelect:t.multiSelect}},get children(){return e(Ve,{forceRoot:!0,onChange:i=>{},get multiSelect(){return t.multiSelect},selectedPaths:a,onSelect:w,get autoOpen(){return t.autoOpen}})}})}}),e(ge,{get children(){return[e(R,{colorScheme:"neutral",onClick:h,mr:"$2",get children(){return d("global.cancel")}}),e(R,{onClick:h,get children(){return d("global.confirm")}})]}})]}})]}})]},Xe=async t=>{const m=new Map,l=async r=>{try{const n=await N(r,ee(),!0);if(n.code===200)return n.data.map(C=>Ae(r,C.name))}catch(n){console.error(`获取目录 [${r}] 内容失败:`,n)}return[]},h=r=>{if(r==="/"||!r.includes("/"))return"";const n=r.lastIndexOf("/");return n===0?"/":r.substring(0,n)},d=new Set;t.forEach(r=>d.add(r)),t.forEach(r=>{let n=h(r);for(;n!=="";)d.add(n),n=h(n)});for(const r of d)if(!m.has(r)){const n=await l(r);m.set(r,n)}const s=(r,n)=>n==="/"?r!=="/":r.startsWith(n+"/"),f=(r,n)=>{const u=m.get(r)||[];return u.length===0?!1:u.every(C=>n.has(C)||f(C,n))},a=new Set,$=new Set(t),w=[...t].sort((r,n)=>r.length-n.length);for(const r of w){let n=!1;for(const u of a)if(r!==u&&s(r,u)){n=!0;break}n||(f(r,$),a.add(r))}return a.size===0&&t.length>0&&a.add(t[0]),Array.from(a)},Ge=()=>{const t=le(),{params:m,back:l,to:h}=ve(),{id:d}=m,[s,f]=xe({name:"",description:"",permission_scopes:[],base_path:[]});y([]);const[a,$]=y(0),[w,i]=y(!1),[r,n]=y(!1),u=async()=>{var o;try{const g=await qe.get("/fs/list");return g.code===500&&((o=g.message)!=null&&o.includes("please add a storage first"))?(n(!0),!1):!0}catch(g){return console.error("Failed to check storage:",g),!1}},[C,S]=G(()=>je(parseInt(d))),v=async()=>{const o=await u();if(i(o),!!o&&d){const g=await S();te(g,p=>{var P,B;f({name:p.name||"",description:p.description||"",permission_scopes:p.permission_scopes||[],base_path:(P=p.permission_scopes)!=null&&P.length?p.permission_scopes.map(F=>F.path):[]}),((B=p.permission_scopes)==null?void 0:B.length)>0&&$(p.permission_scopes[0].permission)})}};Oe(()=>{v()});const U=()=>s.base_path.length===0||s.name.length===0?(oe.error(t("users.base_path")+" "+t("global.required")),!1):!0,[V,K]=G(async()=>{const o=W.reduce((P,B,F)=>(a()>>F&1)===1?P|1<<F:P,0),g=await Xe(s.base_path),p={name:s.name,description:s.description,permission_scopes:g.map(P=>({path:P,permission:o}))};return d?Ie({...p,id:parseInt(d)}):Fe(p)}),x=()=>W.filter((o,g)=>(a()>>g&1)===1),j=o=>{const g=1<<o,p=a()^g;$(p),s.base_path&&(p>>o&1?f("permission_scopes",[...s.permission_scopes,{permission:g,path:s.base_path[0]}]):f("permission_scopes",s.permission_scopes.filter(P=>P.permission!==g||P.path!==s.base_path[0])))};return e(q,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(Re,{get children(){return t(d?"global.edit":"global.add")}}),e(Me,{get loading(){return C()},get children(){return e(_,{get when(){return w()},get children(){return e(q,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[e(E,{required:!0,get children(){return[e(H,{get children(){return t("permissions.role.role_name")}}),e(Z,{get value(){return s.name},onInput:o=>f("name",o.currentTarget.value)})]}}),e(E,{get children(){return[e(H,{get children(){return t("permissions.role.role_description")}}),e(Z,{get value(){return s.description},onInput:o=>f("description",o.currentTarget.value)})]}}),e(E,{required:!0,get children(){return[e(H,{get children(){return t("users.base_path")}}),e(Ke,{id:"base_path",get value(){return s.base_path},onChange:o=>{f("base_path",o)},multiSelect:!0,autoOpen:!!d})]}}),e(E,{get children(){return[e(H,{get children(){return t("permissions.config.permissions_permissions")}}),e(De,{multiple:!0,get value(){return x()},get children(){return[e(Te,{get children(){return e(M,{display:"flex",flexWrap:"wrap",gap:"$2",pr:"$6",py:"$2",minH:"40px",alignItems:"center",get children(){return e(_,{get when(){return x().length>0},get fallback(){return e(ze,{get children(){return t("permissions.config.select_permissions")}})},get children(){return[e(z,{get each(){return x().slice(0,3)},children:(o,g)=>e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return[e(A,{get children(){return t(`users.permissions.${o}`)}}),e(Be,{onClick:p=>{p.stopPropagation(),j(W.indexOf(o))}})]}})}),e(_,{get when(){return x().length>3},get children(){return e(L,{size:"lg",variant:"subtle",bgColor:"$neutral2",rounded:"$sm",px:"$3",py:"$1",get children(){return e(A,{get children(){return["+",J(()=>x().length-3)]}})}})}})]}})}})}}),e(We,{get children(){return e(Ee,{get children(){return e(z,{each:W,children:(o,g)=>e(He,{value:o,onClick:()=>j(g()),get children(){return e(Q,{spacing:"$2",w:"$full",pl:"$4",fontSize:"$lg",get children(){return[e(fe,{get checked(){return(a()>>g()&1)===1},readOnly:!0}),e(Le,{get children(){return t(`users.permissions.${o}`)}})]}})}})})}})}})]}})]}}),e(Q,{spacing:"$2",get children(){return[e(R,{get loading(){return V()},onClick:async()=>{if(!U())return;const o=await K();te(o,()=>{oe.success(t("global.save_success")),l()})},get children(){return t("global.save")}}),e(R,{colorScheme:"accent",onClick:()=>l(),get children(){return t("global.back")}})]}})]}})}})}}),e(he,{get opened(){return r()},onClose:()=>n(!1),get children(){return[e(ie,{}),e(ce,{get children(){return[e(ue,{}),e(de,{get children(){return t("storages.no_storage_content")}}),e(ge,{get children(){return[e(R,{colorScheme:"accent",onClick:()=>n(!1),get children(){return t("global.cancel")}}),e(R,{onClick:()=>{n(!1),h("/@manage/storages")},ml:"$2",get children(){return t("home.go_to_storages")}})]}})]}})]}})]}})};export{Ge as default};
