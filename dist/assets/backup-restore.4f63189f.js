import{d as A,e as V,a as o,b5 as i,f as r,a0 as L,B as h,W as k,v as Y,bb as _,h as b,n as q}from"./index.3990f5de.js";const $={success:{icon:"\u2705",color:"$success9"},error:{icon:"\u274C",color:"$danger9"},info:{icon:"\u2139\uFE0F",color:"$info9"}},z=e=>r(L,{w:"$full",spacing:"$1",get children(){return[r(_,{get children(){return $[e.type].icon}}),r(_,{get color(){return $[e.type].color},get children(){return e.msg}})]}}),P=()=>{const e=A();let g;const[f,u]=V([]),n=(t,s)=>{u(c=>[...c,{type:s,msg:t}]),g.scrollTop=g.scrollHeight},[y,S]=o(()=>i.get("/admin/setting/list")),[w,R]=o(()=>i.get("/admin/user/list")),[U,v]=o(()=>i.get("/admin/meta/list")),[j,M]=o(()=>i.get("/admin/storage/list")),x=()=>y()||w()||U()||j(),B=async()=>{n(e("br.start_backup"),"info");const t={settings:[],users:[],storages:[],metas:[]};for(const s of[{name:"settings",fn:S,page:!1},{name:"users",fn:R,page:!0},{name:"storages",fn:M,page:!0},{name:"metas",fn:v,page:!0}]){const c=await s.fn();b(c,d=>{n(e("br.success_backup_item",{item:e(`manage.sidemenu.${s.name}`)}),"success"),s.page?t[s.name]=d.content:t[s.name]=d},d=>{n(e("br.failed_backup_item",{item:e(`manage.sidemenu.${s.name}`)})+":"+d,"error")})}G("alist_backup_"+new Date().toLocaleString()+".json",t),n(e("br.finish_backup"),"info")},[O,T]=o(t=>i.post("/admin/setting/save",t)),[C,D]=o(t=>i.post("/admin/user/create",t)),[F,N]=o(t=>i.post("/admin/storage/create",t)),[E,H]=o(t=>i.post("/admin/meta/create",t)),I=()=>O()||C()||F()||E(),J=async()=>{n(e("br.start_restore"),"info");const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=async s=>{const c=s.target.files;if(!c||c.length===0){q.warning(e("br.no_file"));return}const d=c[0],p=new FileReader;p.onload=async()=>{const l=JSON.parse(p.result);l.settings&&b(await T(l.settings.filter(a=>!["version","index_progress"].includes(a.key))),()=>{n(e("br.success_restore_item",{item:e("manage.sidemenu.settings")}),"success")},a=>{n(e("br.failed_restore_item",{item:e("manage.sidemenu.settings")})+":"+a,"error")});for(const a of[{name:"users",fn:D,data:l.users,key:"username"},{name:"storages",fn:N,data:l.storages,key:"mount_path"},{name:"metas",fn:H,data:l.metas,key:"path"}])for(const m of a.data||[])m.id=0,b(await a.fn(m),()=>{n(e("br.success_restore_item",{item:e(`manage.sidemenu.${a.name}`)})+`-[${m[a.key]}]`,"success")},W=>{n(e("br.failed_restore_item",{item:e(`manage.sidemenu.${a.name}`)})+` [ ${m[a.key]} ] :`+W,"error")});n(e("br.finish_restore"),"info")},p.readAsText(d)},t.click()};return r(k,{spacing:"$2",w:"$full",get children(){return[r(L,{spacing:"$2",alignItems:"start",w:"$full",get children(){return[r(h,{get loading(){return x()},onClick:()=>{B()},colorScheme:"accent",get children(){return e("br.backup")}}),r(h,{get loading(){return I()},onClick:()=>{J()},get children(){return e("br.restore")}})]}}),r(k,{p:"$2",ref(t){const s=g;typeof s=="function"?s(t):g=t},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return r(Y,{get each(){return f()},children:t=>r(z,t)})}})]}})};function G(e,g){const f=new Blob([JSON.stringify(g,null,2)],{type:"application/json"}),u=URL.createObjectURL(f),n=document.createElement("a");n.href=u,n.download=e,n.click(),URL.revokeObjectURL(u)}export{P as default};
