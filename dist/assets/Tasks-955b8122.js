import{ay as p,b as V,be as y,bv as x,B as m,x as t,av as L,bg as U,c2 as ee,S as d,aT as q,cZ as Be,c_ as Le,ah as _,c3 as ue,du as he,Q as u,bw as k,n as Y,am as E,ai as D,d_ as De,e0 as $,W as me,cF as Ie,cX as we,A as F,r as Me,H as Oe,L as We,V as S,E as Ge}from"./index-13b290a7.js";import{P as Ve}from"./Paginator-6b8b297f.js";var A;(function(e){e[e.Pending=0]="Pending",e[e.Running=1]="Running",e[e.Succeeded=2]="Succeeded",e[e.Canceling=3]="Canceling",e[e.Canceled=4]="Canceled",e[e.Errored=5]="Errored",e[e.Failing=6]="Failing",e[e.Failed=7]="Failed",e[e.WaitingRetry=8]="WaitingRetry",e[e.BeforeRetry=9]="BeforeRetry"})(A||(A={}));const He={[A.Failed]:"danger",[A.Succeeded]:"success",[A.Canceled]:"neutral"},Ne=e=>{if(e.role<0)return null;const c=["info","neutral","accent"];return t(we,{get colorScheme(){return c[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",text:"ellipsis"},get children(){return e.name}})},je=e=>{const c=V();return t(we,{get colorScheme(){return He[e.state]??"info"},get children(){return c(`tasks.state.${e.state}`)}})},l=[{name:"name",textAlign:"left",w:p().role.includes(2)?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:p().role.includes(2)?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],J=e=>Math.floor(e).toString().padStart(2,"0"),Xe=e=>{const c=e/1e3%60,w=e/1e3/60%60,z=e/1e3/3600;return`${J(z)}:${J(w)}:${J(c)}`},Ke=e=>{const c=V(),w=e.done==="undone"?"cancel":"delete",z=e.done==="done"&&(e.state===A.Failed||e.state===A.Canceled),[v,P]=y(()=>x.post(`/task/${e.type}/${w}?tid=${e.id}`)),[I,H]=y(()=>x.post(`/task/${e.type}/retry?tid=${e.id}`)),[M,T]=m(!1),R=e.name.match(e.nameAnalyzer.regex),N=R===null?e.name:e.nameAnalyzer.title(R,e),i=e.start_time===null?-1:new Date(e.start_time).getTime(),O=e.end_time===null?new Date().getTime():new Date(e.end_time).getTime();let B="-";const W=(a,o)=>{let h=o/a,C="bytes/s";return h>1024&&(h/=1024,C="KB/s"),h>1024&&(h/=1024,C="MB/s"),h>1024&&(h/=1024,C="GB/s"),`${h.toFixed(2)} ${C}`};if(e.done){if(e.start_time!==e.end_time&&e.progress>0&&i!==-1){const a=(O-i)/1e3,o=e.total_bytes*e.progress/100;B=W(a,o)}}else if(e.prevProgress!==void 0&&e.prevFetchTime!==void 0){const a=(e.curFetchTime-e.prevFetchTime)/1e3,o=(e.progress-e.prevProgress)*e.total_bytes/100;B=W(a,o)}return t(d,{get when(){return!M()},get children(){return[t(L,{w:"$full",p:"$2",get children(){return[t(L,{get w(){return l[0].w},spacing:"$1",get children(){return[t(U,{"on:click":a=>{a.stopPropagation()},get checked(){return e.local.selected},onChange:a=>{e.setLocal({selected:a.target.checked,expanded:e.local.expanded})}}),t(ee,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:N})]}}),t(d,{get when(){return p().role.includes(2)},get children(){return t(q,{get w(){return l[1].w},get children(){return t(Ne,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(q,{get w(){return l[2].w},get children(){return t(je,{get state(){return e.state}})}}),t(Be,{get w(){return l[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},mr:"$1",get children(){return t(Le,{color:"$info8",rounded:"$md"})}}),t(q,{get w(){return l[1].w},get children(){return t(_,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:B})}}),t(ue,{get w(){return l[5].w},gap:"$1",get children(){return[t(he,{}),t(d,{get when(){return e.canRetry},get children(){return t(u,{size:"sm",disabled:!z,display:z?"block":"none",get loading(){return I()},onClick:async()=>{const a=await H();k(a,()=>{Y.info(c("tasks.retry")),T(!0)})},get children(){return c("tasks.retry")}})}}),t(u,{size:"sm",colorScheme:"danger",get loading(){return v()},onClick:async()=>{const a=await P();k(a,()=>{Y.success(c("global.delete_success")),T(!0)})},get children(){return c(`global.${w}`)}}),t(u,{size:"sm",colorScheme:"neutral",onClick:()=>{e.setLocal({selected:e.local.selected,expanded:!e.local.expanded})},get children(){return E(()=>!!e.local.expanded,!0)()?c("tasks.fold"):c("tasks.expand")}})]}})]}}),t(d,{get when(){return e.local.expanded},get children(){return t(D,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(De,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(d,{when:i!==-1,get children(){return[t($,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return c("tasks.attr.time_elapsed")}}),t($,{color:"$neutral9",get children(){return Xe(O-i)}})]}}),t(d,{when:R!==null,get children(){return t(me,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:a=>{const o=a[1](R,e);return o===void 0?null:t(d,{get when(){return a[1]!==void 0},get children(){return[t($,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return a[0]}}),t($,{color:"$neutral9",children:o})]}})}})}}),t($,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return c("tasks.attr.status")}}),t($,{color:"$neutral9",get children(){var a,o;return((o=(a=e.nameAnalyzer).statusText)==null?void 0:o.call(a,e))??e.status}}),t(d,{get when(){return e.error},get children(){return[t($,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return c("tasks.attr.err")}}),t($,{color:"$danger9",get children(){return e.error}})]}})]}}),t(Ie,{})]}})}})]}})},Qe=e=>{const c=V(),[w,z]=y(()=>x.get(`/task/${e.type}/${e.done}`)),[v,P]=m([]),[I,H]=m("name"),[M,T]=m(!1),R={name:(r,n)=>r.name>n.name?1:-1,creator:(r,n)=>r.creator===n.creator?r.id>n.id?1:-1:r.creator>n.creator?1:-1,state:(r,n)=>r.state===n.state?r.id>n.id?1:-1:r.state>n.state?1:-1,progress:(r,n)=>r.progress===n.progress?r.id>n.id?1:-1:r.progress<n.progress?1:-1},N=F(()=>(r,n)=>(M()?-1:1)*R[I()](r,n)),i=async()=>{const r=await z();k(r,n=>{const g=new Date().getTime(),ie={},oe={},K={},de={},ge={};for(const s of v())ie[s.id]=s.curFetchTime,oe[s.id]=s.prevFetchTime,K[s.id]=s.progress,de[s.id]=s.prevProgress,ge[s.id]=s.local;P((n==null?void 0:n.map(s=>{let Q,Z;s.progress===K[s.id]?(Q=oe[s.id],Z=de[s.id]):(Q=ie[s.id],Z=K[s.id]);const Te=ge[s.id]??{selected:!1,expanded:!1};return{...s,curFetchTime:g,prevFetchTime:Q,prevProgress:Z,local:Te}}).sort(N()))??[])})};if(i(),e.done==="undone"){const r=setInterval(i,2e3);Me(()=>clearInterval(r))}const[O,B]=y(()=>x.post(`/task/${e.type}/clear_done`)),[W,a]=y(()=>x.post(`/task/${e.type}/clear_succeeded`)),[o,h]=y(()=>x.post(`/task/${e.type}/retry_failed`));console.log("props",e.type);const[C,fe]=m(""),[$e,ye]=m(new RegExp("")),[xe,te]=m(!1);Oe(()=>{try{ye(new RegExp(C())),te(!1)}catch{te(!0)}});const[re,ke]=m(p().role!==2),j=F(()=>{const r=$e(),n=re();return g=>r.test(g.name)&&(!n||g.creator===p().username)}),f=F(()=>v().filter(j())),ne=F(()=>f().map(r=>r.local.selected).every(Boolean)),ve=F(()=>f().map(r=>r.local.selected).some(Boolean)&&!ne()),Ce=r=>P(v().map(n=>(j()(n)&&(n.local.selected=r),n))),ce=F(()=>f().map(r=>r.local.expanded).every(Boolean)),Fe=r=>P(v().map(n=>(j()(n)&&(n.local.expanded=r),n))),le=()=>f().filter(r=>r.local.selected).map(r=>r.id),[Se,_e]=y(()=>x.post(`/task/${e.type}/retry_some`,le())),[pe,Ae]=y(()=>x.post(`/task/${e.type}/${se}_some`,le())),ae=r=>{Object.entries(r).forEach(([n,g])=>{Y.error(`${n}: ${g}`)})},[ze,Pe]=m(1),X=20,se=e.done==="undone"?"cancel":"delete",Re=F(()=>{const r=(ze()-1)*X,n=r+X;return f().slice(r,n)}),b=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),G=r=>({cursor:"pointer",onClick:()=>{I()===r.name?T(!M()):Ge(()=>{H(r.name),T(!1)}),i()}}),be=r=>n=>P(v().map(g=>(g.id===r&&(g.local=n),g)));return t(D,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(ee,{size:"lg",get children(){return c(`tasks.${e.done}`)}}),t(L,{gap:"$2",flexWrap:"wrap",get children(){return[t(d,{get when(){return e.done==="done"},get children(){return[t(u,{colorScheme:"accent",get loading(){return w()},onClick:i,get children(){return c("global.refresh")}}),t(u,{get loading(){return o()},onClick:async()=>{const r=await h();k(r,()=>i())},get children(){return c("tasks.retry_failed")}}),t(u,{colorScheme:"danger",get loading(){return O()},onClick:async()=>{const r=await B();k(r,()=>i())},get children(){return c("global.clear")}}),t(u,{colorScheme:"success",get loading(){return W()},onClick:async()=>{const r=await a();k(r,()=>i())},get children(){return c("tasks.clear_succeeded")}})]}}),t(d,{get when(){return e.canRetry},get children(){return t(u,{colorScheme:"primary",get loading(){return Se()},onClick:async()=>{const r=await _e();k(r,n=>{ae(n),i()})},get children(){return c("tasks.retry_selected")}})}}),t(u,{colorScheme:"warning",get loading(){return pe()},onClick:async()=>{const r=await Ae();k(r,n=>{ae(n),i()})},get children(){return c(`tasks.${se}_selected`)}}),t(We,{width:"auto",get placeholder(){return c("tasks.filter")},get value(){return C()},onInput:r=>fe(r.target.value),get invalid(){return xe()}}),t(d,{get when(){return p().role===2},get children(){return t(U,{get checked(){return re()},onChange:r=>ke(r.target.checked),get children(){return c("tasks.show_only_mine")}})}})]}}),t(D,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(L,{class:"title",w:"$full",p:"$2",get children(){return[t(L,{get w(){return l[0].w},spacing:"$1",get children(){return[t(U,{get disabled(){return f().length===0},get checked(){return ne()},get indeterminate(){return ve()},onChange:r=>Ce(r.target.checked)}),t(_,S(()=>b(l[0]),()=>G(l[0]),{get children(){return c(`tasks.attr.${l[0].name}`)}}))]}}),t(d,{get when(){return p().role===2},get children(){return t(_,S({get w(){return l[1].w}},()=>b(l[1]),()=>G(l[1]),{get children(){return c(`tasks.attr.${l[1].name}`)}}))}}),t(_,S({get w(){return l[2].w}},()=>b(l[2]),()=>G(l[2]),{get children(){return c(`tasks.attr.${l[2].name}`)}})),t(_,S({get w(){return l[3].w}},()=>b(l[3]),()=>G(l[3]),{get children(){return c(`tasks.attr.${l[3].name}`)}})),t(_,S({get w(){return l[4].w}},()=>b(l[4]),{get children(){return c(`tasks.attr.${l[4].name}`)}})),t(ue,{get w(){return l[5].w},gap:"$2",get children(){return[t(he,{}),t(_,S(()=>b(l[5]),{get children(){return c(`tasks.attr.${l[5].name}`)}})),t(u,{size:"xs",colorScheme:"neutral",onClick:()=>Fe(!ce()),get disabled(){return f().length===0},get children(){return E(()=>!!ce(),!0)()?c("tasks.fold_all"):c("tasks.expand_all")}})]}})]}}),E(()=>Re().map(r=>t(Ke,S(r,e,{get setLocal(){return be(r.id)}}))))]}}),t(Ve,{get total(){return f().length},defaultPageSize:X,onChange:r=>{Pe(r)}})]}})},Je=e=>{const c=V();return t(D,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(ee,{size:"xl",get children(){return c(`tasks.${e.type}`)}}),t(D,{w:"$full",spacing:"$2",get children(){return t(me,{each:["undone","done"],children:w=>t(Qe,{get type(){return e.type},done:w,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})};export{Je as T};
