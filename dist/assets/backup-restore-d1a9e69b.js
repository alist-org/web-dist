import{B,b as ve,be as o,bv as c,x as d,av as Y,Q as V,bW as Ue,c3 as Be,bJ as W,bV as De,L as Ne,ai as H,W as Ce,ah as P,cL as y,n as Te}from"./index-6ba85c96.js";import{b as je}from"./useTitle-40d456c9.js";import{c as w}from"./index-eae4058a.js";const Q={success:{icon:"✅",color:"$success9"},error:{icon:"❌",color:"$danger9"},info:{icon:"ℹ️",color:"$info9"}},xe=_=>d(Y,{w:"$full",spacing:"$1",get children(){return[d(P,{get children(){return Q[_.type].icon}}),d(P,{get color(){return Q[_.type].color},get children(){return _.msg}})]}}),Je=()=>{const[_,$]=B(!1),[h,S]=B(""),e=ve();je("manage.sidemenu.backup-restore");let k;const[q,z]=B([]),a=(t,i)=>{z(g=>[...g,{type:i,msg:t}]),k.scrollTop=k.scrollHeight},[G,D]=o(()=>c.get("/label/list")),[K,N]=o(t=>c.post("/admin/label/create",t)),[X,Z]=o(t=>c.post("/admin/label/update",t)),[ee,te]=o(()=>c.get("/admin/label_file_binding/list")),[ne,C]=o(t=>c.post("/admin/label_file_binding/restore",t)),[se,T]=o(()=>c.get("/admin/role/list")),[re,j]=o(t=>c.post("/admin/role/create",t)),[ae,ie]=o(t=>c.post("/admin/role/update",t)),[oe,ce]=o(()=>c.get("/admin/setting/list")),[le,x]=o(()=>c.get("/admin/user/list")),[de,M]=o(()=>c.get("/admin/meta/list")),[ue,O]=o(()=>c.get("/admin/storage/list")),ge=()=>oe()||le()||de()||ue()||G()||ee()||se();function R(t,i){if(i=="")return t;const g=w.AES.encrypt(JSON.stringify(t),i).toString();return w.enc.Base64.stringify(w.enc.Utf8.parse(g))}function I(t,i,g,u){if(!u)return t;const l=w.enc.Base64.parse(t).toString(w.enc.Utf8);return g?w.AES.decrypt(l,i).toString(w.enc.Utf8):JSON.parse(w.AES.decrypt(l,i).toString(w.enc.Utf8))}const F=async()=>{a(e("br.start_backup"),"info");const t={encrypted:"",settings:[],users:[],storages:[],metas:[],labels:[],label_file_bindings:[],roles:[]};h()!=""&&(t.encrypted=R("encrypted",h()));for(const i of[{name:"settings",fn:ce,page:!1},{name:"users",fn:x,page:!0},{name:"storages",fn:O,page:!0},{name:"metas",fn:M,page:!0},{name:"labels",fn:D,page:!0},{name:"label_file_bindings",fn:te,page:!0},{name:"roles",fn:T,page:!0}]){const g=await i.fn();y(g,u=>{if(a(e("br.success_backup_item",{item:e(`manage.sidemenu.${i.name}`)}),"success"),i.page){for(let l=0;l<u.content.length;l++){const r=u.content[l];for(const p in r)r[p]=R(r[p],h())}t[i.name]=u.content}else{for(let l=0;l<u.length;l++){const r=u[l];for(const p in r)r[p]=R(r[p],h())}t[i.name]=u}},u=>{a(e("br.failed_backup_item",{item:e(`manage.sidemenu.${i.name}`)})+":"+u,"error")})}Me("alist_backup_"+new Date().toLocaleString()+".json",t),a(e("br.finish_backup"),"info")},[me,fe]=o(t=>c.post("/admin/setting/save",t)),[pe,J]=o(t=>c.post("/admin/user/create",t)),[be,E]=o(t=>c.post("/admin/storage/create",t)),[_e,A]=o(t=>c.post("/admin/meta/create",t)),[we,he]=o(t=>c.post("/admin/user/update",t)),[ye,Le]=o(t=>c.post("/admin/storage/update",t)),[Se,ke]=o(t=>c.post("/admin/meta/update",t));async function L(t,i,g,u,l,r){const p=(await i()).data.content;for(const v in t){const m=t[v],f=m[l],b=(p.find(U=>U[l]===f)?"update":"add")==="add"?g:u;await y(await b(m),()=>{a(e("br.success_restore_item",{item:e(r)})+`-[${f}]`,"success")},U=>{a(e("br.failed_restore_item",{item:e(r)})+`-[${f}]:`+U,"error")})}}const $e=()=>me()||pe()||be()||_e()||K()||re()||we()||ye()||Se()||X()||ae()||ne(),Re=async()=>{a(e("br.start_restore"),"info");const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=async i=>{const g=i.target.files;if(!g||g.length===0){Te.warning(e("br.no_file"));return}const u=g[0],l=new FileReader;l.onload=async()=>{const r=JSON.parse(l.result),p=!!r.encrypted;if(p&&I(r.encrypted,h(),!0,!0)!=='"encrypted"'){a(e("br.wrong_encrypt_password"),"error");return}const v=["settings","users","storages","metas","labels","label_file_bindings","roles"];for(const m of v){const f=r[m]||[];for(let n=0;n<f.length;n++){const s=f[n];for(const b in s)s[b]=I(s[b],h(),!1,p)}}if(_()&&await F(),r.settings&&y(await fe(r.settings.filter(m=>!["version","index_progress"].includes(m.key))),()=>{a(e("br.success_restore_item",{item:e("manage.sidemenu.settings")}),"success")},m=>{a(e("br.failed_restore_item",{item:e("manage.sidemenu.settings")})+":"+m,"error")}),_()){const m=(r.label_file_bindings||[]).map(s=>({...s,id:typeof s.id=="string"?Number(s.id):s.id,user_id:typeof s.user_id=="string"?Number(s.user_id):s.user_id,label_id:typeof s.label_id=="string"?Number(s.label_id):s.label_id,file_name:String(s.file_name??"")}));await L(r.users,x,J,he,"username","manage.sidemenu.users"),await L(r.storages,O,E,Le,"mount_path","manage.sidemenu.storages"),await L(r.metas,M,A,ke,"path","manage.sidemenu.metas"),await L(r.labels,D,N,Z,"id","manage.sidemenu.labels"),m.length&&await y(await C({keep_ids:!0,override:!0,bindings:m}),()=>{a(e("br.success_restore_item",{item:e("manage.sidemenu.label_file_bindings")}),"success")},s=>{a(e("br.failed_restore_item",{item:e("manage.sidemenu.label_file_bindings")})+":"+s,"error")});const f=new Set(["admin"]),n=(r.roles||[]).filter(s=>{const b=String((s==null?void 0:s.name)??"").toLowerCase();return f.has(b)?(a(e("br.success_restore_item",{item:e("manage.sidemenu.roles")})+` - [${s.name}] skipped (builtin role)`,"info"),!1):!0});await L(n,T,j,ie,"name","manage.sidemenu.roles")}else{const m=(r.users||[]).filter(n=>{const s=String((n==null?void 0:n.username)??"").toLowerCase();return s==="admin"||s==="guest"?(a(e("br.success_restore_item",{item:e("manage.sidemenu.users")})+` - [${n.username}] skipped (builtin user)`,"info"),!1):!0});for(const n of m)n.id=0,await y(await J(n),()=>{a(e("br.success_restore_item",{item:e("manage.sidemenu.users")})+`-[${n.username}]`,"success")},s=>{a(e("br.failed_restore_item",{item:e("manage.sidemenu.users")})+` [ ${n.username} ] :`+s,"error")});for(const n of[{name:"storages",fn:E,data:r.storages,key:"mount_path"},{name:"metas",fn:A,data:r.metas,key:"path"},{name:"labels",fn:N,data:r.labels,key:"name"}])for(const s of n.data||[])s.id=0,await y(await n.fn(s),()=>{a(e("br.success_restore_item",{item:e(`manage.sidemenu.${n.name}`)})+`-[${s[n.key]}]`,"success")},b=>{a(e("br.failed_restore_item",{item:e(`manage.sidemenu.${n.name}`)})+` [ ${s[n.key]} ] :`+b,"error")});for(const n of r.roles||[]){const s=String((n==null?void 0:n.name)??"").toLowerCase();if(["admin","guest","general"].includes(s)){a(e("br.success_restore_item",{item:e("manage.sidemenu.roles")})+` - [${n.name}] skipped (builtin role)`,"info");continue}"id"in n&&delete n.id,await y(await j(n),()=>{a(e("br.success_restore_item",{item:e("manage.sidemenu.roles")})+`-[${n.name}]`,"success")},b=>{a(e("br.failed_restore_item",{item:e("manage.sidemenu.roles")})+`-[${n.name}]:`+b,"error")})}const f=(r.label_file_bindings||[]).map(n=>({...n,id:typeof n.id=="string"?Number(n.id):n.id,user_id:typeof n.user_id=="string"?Number(n.user_id):n.user_id,label_id:typeof n.label_id=="string"?Number(n.label_id):n.label_id,file_name:String(n.file_name??"")}));f.length&&await y(await C({keep_ids:!0,override:!1,bindings:f}),()=>{a(e("br.success_restore_item",{item:e("manage.sidemenu.label_file_bindings")}),"success")},n=>{a(e("br.failed_restore_item",{item:e("manage.sidemenu.label_file_bindings")})+":"+n,"error")})}a(e("br.finish_restore"),"info")},l.readAsText(u)},t.click()};return d(H,{spacing:"$2",w:"$full",get children(){return[d(Y,{spacing:"$2",w:"$full",get children(){return[d(V,{get loading(){return ge()},onClick:()=>{F()},colorScheme:"accent",get children(){return e("br.backup")}}),d(V,{get loading(){return $e()},onClick:()=>{Re()},get children(){return e("br.restore")}})]}}),d(Ue,{w:"$full",display:"flex",flexDirection:"column",get children(){return d(Be,{w:"$full",direction:"column",gap:"$1",get children(){return[d(W,{for:"restore-override",get children(){return e("br.override")}}),d(De,{id:"restore-override",get checked(){return _()},onChange:t=>$(t.currentTarget.checked)}),d(W,{for:"password",get children(){return e("br.encrypt_password")}}),d(Ne,{id:"password",type:"password",get placeholder(){return e("br.encrypt_password_placeholder")},onInput:t=>S(t.currentTarget.value)})]}})}}),d(H,{p:"$2",ref(t){const i=k;typeof i=="function"?i(t):k=t},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return d(Ce,{get each(){return q()},children:t=>d(xe,t)})}})]}})};function Me(_,$){const h=new Blob([JSON.stringify($,null,2)],{type:"application/json"}),S=URL.createObjectURL(h),e=document.createElement("a");e.href=S,e.download=_,e.click(),URL.revokeObjectURL(S)}export{Je as default};
